%h2
  Search for Tags

%p Enter a comma seperated list of tags you would like to search for.  These can be both internal and external tags.

%textarea{:class => 'tags_input'}
%br

%button{:class => 'searcher'} Search
.clear
%span{:style => 'font-size: 80%; font-weight: bold;'}
  Example: A69-9002-4807 (full code space), 31942 (internal tag), 4257 (external tag)

#search_tag_table
  %h5{:id => 'tag_count'}
  %br
  %div{:id => 'tags'}
.clear

:javascript

  function buildTagBox(val,lastbox_class) {
    text = "";
    text += "<div class='searchbox " + lastbox_class + "'>";
      text += "<h3 class='searchable'>" + val.code + "</h3>";
      text += "<ol>";
        text += "<li>Code Space: <span class='searchable'>" + val.code_space + "</span></li>";
        text += "<li>Study: <a href='/studies/" + val.study.id + "'>" + val.study.name + "</a></li>";
        if (!jQuery.isEmptyObject(val.active_deployment_json)) {
          text += "<h4>Active Deployment</h4>";
          text += "<li><ol>"
          text += "<li>External Codes: <span class='searchable'>" + val.active_deployment_json.external_codes + "</span></li>";
          text += "<li>Release Date: " + val.active_deployment_json.release_date + "</li>";
          text += "<li>Common Name: " + val.active_deployment_json.common_name + "</li>";
          text += "<li>Length: " + val.active_deployment_json.length + "</li>";
          text += "<li>Weight: " + val.active_deployment_json.weight + "</li>";
          text += "<li>Age: " + val.active_deployment_json.age + "</li>";
          text += "<li>Sex: " + val.active_deployment_json.sex + "</li>";
          text += "</ol></li>"
        } else {
          text += "<h4>No Active Deployment</h4>";
        }
      text += "</ol>";
    text += "</div>";
    return text;
  }

  $(document).ready(function() {

    $(".searcher").click(function(e) {
      e.preventDefault();

      var phrase = $(".tags_input").val();

      $.ajax({
        type: "GET",
        url: "#{multi_tag_search_path({:format => :js})}",
        data: "text="+phrase,
        dataType: 'json',
        success: function(data){
          var items = [];
          $("#tag_count").html(data.length + " results")
          var count = 1;
          $.each(data, function(key, val) {
            lastbox_class = "";
            if (count % 3 == 0) {
              lastbox_class = "last_searchbox";  
            }
            items.push(buildTagBox(val,lastbox_class));
            count++;
          });
          $('#tags').html(items.join(''));
          // Highlight the search terms
          $.each(phrase.split(','),function(k,v) {
            $('.searchable').highlight(v.split(' '));
          });
        },
        error: function(){
          // no tags
        }
      });

    });

  });
